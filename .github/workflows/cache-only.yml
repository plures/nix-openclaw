name: Cache Only

on:
  workflow_run:
    workflows: [ "Nix Build & Cache" ]
    types: [ completed ]
  workflow_dispatch: {}

jobs:
  cache-only:
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      TARGET_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
      CACHIX_CACHE_NAME: ${{ vars.CACHIX_CACHE_NAME }}
      WAIT_MINUTES: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_SHA }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Cachix (read-only)
        if: ${{ vars.CACHIX_CACHE_NAME != '' }}
        uses: cachix/cachix-action@v15
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}

      - name: Verify Cachix has required outputs
        run: |
          set -euo pipefail

          if [ -z "${CACHIX_CACHE_NAME:-}" ]; then
            echo "vars.CACHIX_CACHE_NAME not set; skipping cache verification."
            exit 0
          fi

          STORE_URL="https://${CACHIX_CACHE_NAME}.cachix.org"
          echo "Checking cache: ${STORE_URL}"

          targets=(
            packages.aarch64-darwin.openclaw
            packages.aarch64-darwin.openclaw-gateway
            packages.aarch64-darwin.openclaw-tools
            packages.aarch64-darwin.openclaw-app
            packages.x86_64-linux.openclaw
            packages.x86_64-linux.openclaw-gateway
            packages.x86_64-linux.openclaw-tools
            checks.aarch64-darwin.gateway
            checks.x86_64-linux.gateway
            checks.x86_64-linux.gateway-tests
            checks.x86_64-linux.config-options
          )

          deadline=$(( $(date +%s) + WAIT_MINUTES * 60 ))

          while true; do
            missing=()
            for target in "${targets[@]}"; do
              out_path=$(nix --extra-experimental-features 'nix-command flakes' eval --accept-flake-config --raw ".#${target}.outPath")
              if ! nix path-info --store "$STORE_URL" "$out_path" >/dev/null 2>&1; then
                missing+=("${target}:${out_path}")
              fi
            done

            if [ ${#missing[@]} -eq 0 ]; then
              echo "Cache ready on ${STORE_URL}."
              break
            fi

            if [ "$(date +%s)" -gt "$deadline" ]; then
              echo "Cache missing after ${WAIT_MINUTES} minutes:"
              printf ' - %s\n' "${missing[@]}"
              exit 1
            fi

            echo "Cache still missing (${#missing[@]}). Retrying in 30s..."
            sleep 30
          done
