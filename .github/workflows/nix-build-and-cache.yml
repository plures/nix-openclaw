name: Nix Build & Cache

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_run:
    workflows: [ "Yolo Update Pins" ]
    types: [ completed ]

jobs:
  build-and-cache-linux:
    name: build-and-cache-linux
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      TARGET_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
      CACHIX_CACHE_NAME: ${{ vars.CACHIX_CACHE_NAME }}
      CACHIX_PUSH: ${{ secrets.CACHIX_AUTH_TOKEN != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_SHA }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Cachix (read-only)
        if: ${{ vars.CACHIX_CACHE_NAME != '' }}
        uses: cachix/cachix-action@v15
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}

      - name: Setup Cachix (push)
        if: ${{ vars.CACHIX_CACHE_NAME != '' && secrets.CACHIX_AUTH_TOKEN != '' }}
        uses: cachix/cachix-action@v15
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build (push on main only)
        run: |
          set -euo pipefail

          targets=(
            .#packages.x86_64-linux.openclaw
            .#packages.x86_64-linux.openclaw-gateway
            .#packages.x86_64-linux.openclaw-tools
            .#checks.x86_64-linux.gateway
            .#checks.x86_64-linux.gateway-tests
            .#checks.x86_64-linux.config-options
            .#checks.x86_64-linux.default-instance
            .#checks.x86_64-linux.config-validity
            .#checks.x86_64-linux.package-contents
          )

          if [ -n "${CACHIX_CACHE_NAME:-}" ] && [ "${CACHIX_PUSH:-false}" = "true" ]; then
            echo "Building + pushing to Cachix cache: ${CACHIX_CACHE_NAME}"
            cachix watch-exec "${CACHIX_CACHE_NAME}" -- \
              nix build --accept-flake-config --print-build-logs "${targets[@]}"
          else
            echo "Building without Cachix push (PR/fork or Cachix not configured)."
            nix build --accept-flake-config --print-build-logs "${targets[@]}"
          fi

  build-and-cache-macos:
    name: build-and-cache-macos
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: macos-14
    env:
      TARGET_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
      CACHIX_CACHE_NAME: ${{ vars.CACHIX_CACHE_NAME }}
      CACHIX_PUSH: ${{ secrets.CACHIX_AUTH_TOKEN != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_SHA }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Cachix (read-only)
        if: ${{ vars.CACHIX_CACHE_NAME != '' }}
        uses: cachix/cachix-action@v15
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}

      - name: Setup Cachix (push)
        if: ${{ vars.CACHIX_CACHE_NAME != '' && secrets.CACHIX_AUTH_TOKEN != '' }}
        uses: cachix/cachix-action@v15
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build (push on main only)
        run: |
          set -euo pipefail

          targets=(
            .#packages.aarch64-darwin.openclaw
            .#packages.aarch64-darwin.openclaw-gateway
            .#packages.aarch64-darwin.openclaw-tools
            .#packages.aarch64-darwin.openclaw-app
            .#checks.aarch64-darwin.gateway
          )

          if [ -n "${CACHIX_CACHE_NAME:-}" ] && [ "${CACHIX_PUSH:-false}" = "true" ]; then
            echo "Building + pushing to Cachix cache: ${CACHIX_CACHE_NAME}"
            cachix watch-exec "${CACHIX_CACHE_NAME}" -- \
              nix build --accept-flake-config --print-build-logs "${targets[@]}"
          else
            echo "Building without Cachix push (PR/fork or Cachix not configured)."
            nix build --accept-flake-config --print-build-logs "${targets[@]}"
          fi
